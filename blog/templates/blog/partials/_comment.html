<div class="ms-{{ depth }} mt-3 p-2 border rounded bg-light" id="comment-{{ comment.id }}"
data-edit-active="{% if edit_comment and edit_comment.id == comment.id %}true{% else %}false{% endif %}">
    <div class="fw-bold  text-gradient">{{ comment.author }}</div>
    <div class="text-muted small text-gradient">{{ comment.created_at|date:"F j, Y, g:i a" }}</div>

    {% if edit_comment and comment.id == edit_comment.id %}
    <form method="POST" action="{% url 'edit_comment' comment.id %}">
        {% csrf_token %}
        {{ edit_form.as_p }}
        <button type="submit" class="btn btn-sm btn-outline">Update</button>
    </form>
    {% else %}
    <p class="mb-0">{{ comment.content }}</p>
    {% endif %}

    {% if request.user.is_authenticated %}
    <!-- Reply Button -->
    <button class="btn btn-sm text-primary comment-action-btn" data-bs-toggle="collapse"
        data-bs-target="#replyForm{{ comment.id }}">
        Reply
    </button>

    <div class="collapse mt-2" id="replyForm{{ comment.id }}">
        <form method="POST" action="{% url 'blog_detail' post.slug %}#comments">
            {% csrf_token %}
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            {{ form.as_p }}
            <button type="submit" class="btn btn-sm btn-outline">Post Reply</button>
        </form>
    </div>
    {% endif %}

    {% if request.user == comment.author %}
    <!-- Edit Button -->
    <a href="{% url 'edit_comment' comment.id %}?next={{ request.path }}"
        class="btn btn-sm text-success comment-action-btn">‚úèÔ∏è Edit</a>

    <!-- Delete Button -->
    <button type="button" class="btn btn-sm text-danger comment-action-btn" data-bs-toggle="modal"
        data-bs-target="#deleteCommentModal{{ comment.id }}">
        üóëÔ∏è Delete
    </button>


    <div class="modal fade" id="deleteCommentModal{{ comment.id }}" tabindex="-1"
        aria-labelledby="deleteModalLabel{{ comment.id }}" aria-hidden="true" style="z-index: 2000; position: fixed;">

        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="POST" action="{% url 'delete_comment' comment.id %}?next={{ request.path }}">
                    {% csrf_token %}
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel{{ comment.id }}">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this comment?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% for reply in comment.replies.all %}
    {% include "blog/partials/_comment.html" with comment=reply depth=depth|add:"1" %}
    {% endfor %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const commentId = '{{ comment.id }}';
        const commentEl = document.getElementById(`comment-${commentId}`);
        const replyForm = document.getElementById(`replyForm${commentId}`);
        const modalEl = document.getElementById(`deleteCommentModal${commentId}`);
        const actionButtons = commentEl.querySelectorAll('.comment-action-btn');

        function disableAllActions() {
            actionButtons.forEach(btn => btn.disabled = true);
        }

        function enableAllActions() {
            const replyVisible = replyForm?.classList.contains('show');
            const modalVisible = modalEl?.classList.contains('show');
            const editActive = commentEl.dataset.editActive === "true";

            if (!replyVisible && !modalVisible && !editActive) {
                actionButtons.forEach(btn => btn.disabled = false);
            }
        }

        // Reply form toggle
        replyForm?.addEventListener('show.bs.collapse', disableAllActions);
        replyForm?.addEventListener('hidden.bs.collapse', enableAllActions);

        // Modal toggle
        modalEl?.addEventListener('show.bs.modal', disableAllActions);
        modalEl?.addEventListener('hidden.bs.modal', enableAllActions);

        // Disable immediately if edit is active
        if (commentEl.dataset.editActive === "true") {
            disableAllActions();
        }
    });
</script>